name: Auto Ready PR 1345

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  pull-requests: write
  contents: read
  statuses: read
  checks: read

jobs:
  check-and-mark-ready:
    name: Check CI Status and Mark Ready
    runs-on: ubuntu-latest
    # Only run for PR #1345
    if: github.event.pull_request.number == 1345 || (github.event.workflow_run && github.event.workflow_run.pull_requests[0].number == 1345)
    steps:
      - name: Get PR Number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
          fi
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR Number: $PR_NUMBER"

      - name: Get PR Details
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr-number.outputs.number }}
            });
            
            console.log('PR Draft Status:', pr.data.draft);
            console.log('PR State:', pr.data.state);
            console.log('PR Head SHA:', pr.data.head.sha);
            console.log('PR Node ID:', pr.data.node_id);
            
            return {
              draft: pr.data.draft,
              state: pr.data.state,
              sha: pr.data.head.sha,
              user: pr.data.user.login,
              node_id: pr.data.node_id
            };

      - name: Wait for CI Workflows
        if: fromJSON(steps.pr-details.outputs.result).draft == true
        run: |
          echo "Waiting 30 seconds for workflows to start..."
          sleep 30

      - name: Check All CI Status
        id: check-status
        if: fromJSON(steps.pr-details.outputs.result).draft == true
        uses: actions/github-script@v7
        with:
          script: |
            const prDetails = ${{ steps.pr-details.outputs.result }};
            const sha = prDetails.sha;
            
            console.log('Checking status for SHA:', sha);
            
            // Get all check runs for this commit
            const checkRuns = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha,
              per_page: 100
            });
            
            console.log('Total check runs:', checkRuns.data.total_count);
            
            // Filter for CI-related checks (excluding this workflow)
            const relevantChecks = checkRuns.data.check_runs.filter(check => 
              !check.name.includes('Auto Ready PR 1345') &&
              !check.name.includes('Claude Code') &&
              !check.name.includes('Copilot')
            );
            
            console.log('Relevant checks:', relevantChecks.length);
            
            // Check if all required workflows have completed
            const ciWorkflows = relevantChecks.filter(check => 
              check.app.slug === 'github-actions'
            );
            
            if (ciWorkflows.length === 0) {
              console.log('No CI workflows found yet, will retry later');
              return { ready: false, reason: 'no_workflows', checks: [] };
            }
            
            // Check status of all CI checks
            const pending = ciWorkflows.filter(check => 
              check.status !== 'completed'
            );
            
            const failed = ciWorkflows.filter(check => 
              check.status === 'completed' && 
              check.conclusion !== 'success' && 
              check.conclusion !== 'skipped' &&
              check.conclusion !== 'neutral'
            );
            
            console.log('Pending checks:', pending.length);
            console.log('Failed checks:', failed.length);
            
            // Log details
            for (const check of ciWorkflows) {
              console.log(`  ${check.name}: ${check.status} - ${check.conclusion}`);
            }
            
            if (pending.length > 0) {
              return { 
                ready: false, 
                reason: 'pending', 
                pending: pending.map(c => c.name),
                checks: ciWorkflows 
              };
            }
            
            if (failed.length > 0) {
              return { 
                ready: false, 
                reason: 'failed', 
                failed: failed.map(c => ({ name: c.name, url: c.html_url })),
                checks: ciWorkflows 
              };
            }
            
            return { 
              ready: true, 
              reason: 'all_passed',
              checks: ciWorkflows 
            };

      - name: Mark PR as Ready for Review
        if: |
          fromJSON(steps.pr-details.outputs.result).draft == true &&
          fromJSON(steps.check-status.outputs.result).ready == true
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-number.outputs.number }};
            const prDetails = ${{ steps.pr-details.outputs.result }};
            const nodeId = prDetails.node_id;
            
            console.log('Marking PR', prNumber, 'as ready for review');
            console.log('PR Node ID:', nodeId);
            
            // Convert draft PR to ready for review
            await github.graphql(`
              mutation {
                markPullRequestReadyForReview(input: {pullRequestId: "${nodeId}"}) {
                  pullRequest {
                    id
                    number
                    draft
                  }
                }
              }
            `);
            
            // Add a comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '✅ All CI checks have passed! This PR is now ready for review.'
            });
            
            console.log('PR marked as ready for review!');

      - name: Comment on Failure
        if: |
          fromJSON(steps.pr-details.outputs.result).draft == true &&
          fromJSON(steps.check-status.outputs.result).reason == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-number.outputs.number }};
            const statusResult = ${{ steps.check-status.outputs.result }};
            const prUser = ${{ steps.pr-details.outputs.result }}.user;
            
            const failedChecks = statusResult.failed.map(check => 
              `- ❌ [${check.name}](${check.url})`
            ).join('\n');
            
            const message = `⚠️ @${prUser} Some CI checks have failed:\n\n${failedChecks}\n\nPlease review and fix the failures.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: message
            });
            
            console.log('Failure comment posted');
